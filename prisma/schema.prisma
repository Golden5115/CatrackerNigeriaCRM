generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- ENUMS ---
enum Role {
  ADMIN
  CSR
  INSTALLER
  TECH_SUPPORT
}

enum JobStatus {
  NEW_LEAD
  SCHEDULED
  IN_PROGRESS
  PENDING_QC
  CONFIGURED
  ACTIVE
  LEAD_LOST
}

enum StockStatus {
  IN_STOCK
  INSTALLED
  FAULTY
  RETIRED
}

// --- MODELS ---

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  password       String
  fullName       String?
  role           Role      @default(CSR)
  accessibleModules String[] @default([]) // Stores things like ["LEADS", "TECH", "PAYMENTS"]
  
  createdAt      DateTime  @default(now())
  
  clientsAdded   Client[]  @relation("CreatedBy")
  installerJobs  Job[]     @relation("InstallerJobs")
}

model Client {
  id          String    @id @default(uuid())
  fullName    String
  phoneNumber String    @unique
  notes       String?
  
  // --- LEAD INFO ---
  email       String?   @unique   
  dob         DateTime?
  address     String?
  state       String?
  leadSource  String?

  // --- RELATIONSHIPS ---
  vehicles    Vehicle[]
  
  createdById String?
  createdBy   User?     @relation("CreatedBy", fields: [createdById], references: [id])
  
  createdAt   DateTime  @default(now())
}

model Vehicle {
  id          String    @id @default(uuid())
  clientId    String
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  name        String    
  year        String?    
  plateNumber String?
  color       String?
  jobs        Job[]
}

// 3. Independent Device Table (IMEI Only)
model Device {
  id        String       @id @default(cuid())
  imei      String       @unique
  status    StockStatus  @default(IN_STOCK)
  
  job       Job?
  createdAt DateTime     @default(now())
}

// 4. Independent SIM Table (Number Only)
model SimCard {
  id        String       @id @default(cuid())
  simNumber String       @unique
  network   String?      
  status    StockStatus  @default(IN_STOCK)

  job       Job?
  createdAt DateTime     @default(now())
}

model Job {
  id              String      @id @default(uuid())
  vehicleId       String
  vehicle         Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  
  // ❌ DELETED THE DUPLICATE LINE THAT WAS HERE ❌

  installerId     String?
  installer       User?       @relation("InstallerJobs", fields: [installerId], references: [id])
  
  status          JobStatus   @default(NEW_LEAD)
  
  // 2. Separate Relations for Device and SIM
  deviceId        String?     @unique
  device          Device?     @relation(fields: [deviceId], references: [id])

  simCardId       String?     @unique
  simCard         SimCard?    @relation(fields: [simCardId], references: [id])

  lostReason      String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Installation Data
  installDate     DateTime?
  installPhoto    String?
  odometer        Int?
  installerName   String?

  // Tech Data
  configurationDate DateTime? 
  serverConfig      Boolean   @default(false)
  platformId        String?
  
  // CSR / Payment Data
  onboarded         Boolean   @default(false)
  paymentStatus     String    @default("UNPAID")
  amountPaid        Decimal   @default(0.00) 
  paymentCollector  String?   
}